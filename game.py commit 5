import pygame
import random
from entities import Player, Bullet, Enemy

class Game:
    def __init__(self, window, width, height):
        self.window = window
        self.width = width
        self.height = height

        self.player = Player(width // 2, height - 60)
        self.bullets = []
        self.enemy_bullets = []
        self.enemies = []

        self.enemy_direction = 1
        self.enemy_speed = 1
        self.score = 0
        self.lives = 3
        self.player_respawn_time = 0

        self.create_enemy_grid()

    def create_enemy_grid(self):
        rows = 5
        cols = 10
        x_offset = 55
        y_offset = 40

        for row in range(rows):
            for col in range(cols):
                x = x_offset + col * 60
                y = y_offset + row * 50
                self.enemies.append(Enemy(x, y))

    def update(self):
        # Game over
        if self.lives <= 0:
            return

        keys = pygame.key.get_pressed()
        self.player.update(keys, self.bullets)

        # Player bullets
        for bullet in self.bullets[:]:
            bullet.update()

            bullet_rect = pygame.Rect(
                bullet.x - bullet.radius, bullet.y - bullet.radius,
                bullet.radius * 2, bullet.radius * 2
            )

            for enemy in self.enemies[:]:
                if bullet_rect.colliderect(enemy.get_rect()):
                    self.enemies.remove(enemy)
                    self.score += 100
                    if bullet in self.bullets:
                        self.bullets.remove(bullet)
                    break

        # Enemy movement
        move_down = False
        for enemy in self.enemies:
            enemy.x += self.enemy_direction * self.enemy_speed
            if enemy.x <= 0 or enemy.x + enemy.width >= self.width:
                move_down = True

        if move_down:
            self.enemy_direction *= -1
            for enemy in self.enemies:
                enemy.y += 5

        # Enemy random shooting
        if len(self.enemies) > 0:
            shooter = random.choice(self.enemies)
            if random.random() < 0.02:
                bx = shooter.x + shooter.width // 2
                by = shooter.y + shooter.height
                self.enemy_bullets.append(Bullet(bx, by, +1))

        # Enemy bullet updates
        for bullet in self.enemy_bullets[:]:
            bullet.update()

            bullet_rect = pygame.Rect(
                bullet.x - bullet.radius, bullet.y - bullet.radius,
                bullet.radius * 2, bullet.radius * 2
            )

            if self.player_respawn_time == 0 and bullet_rect.colliderect(self.player.get_rect()):
                self.enemy_bullets.remove(bullet)
                self.lives -= 1
                self.player_respawn_time = 120
                self.player.x = self.width // 2

        if self.player_respawn_time > 0:
            self.player_respawn_time -= 1

    def draw(self):
        self.window.fill((0, 0, 0))

        font = pygame.font.SysFont(None, 30)
        self.window.blit(font.render(f"Lives: {self.lives}", True, (255, 255, 255)), (10, 10))
        self.window.blit(font.render(f"Score: {self.score}", True, (255, 255, 255)), (10, 40))

        self.player.draw(self.window)

        for enemy in self.enemies:
            enemy.draw(self.window)

        for b in self.bullets:
            b.draw(self.window)

        for b in self.enemy_bullets:
            b.draw(self.window)
